const{createApp,ref,reactive,watch,onMounted,onUnmounted}=Vue,uid="onecomme.plugin.template-utils",LIMIT=30,app=createApp({setup(){const e=new URLSearchParams(window.location.search),t=`${window.location.pathname}`.substring(1).split("/").slice(1,3).join("/")||null,o=reactive({baseURL:`${window.location.protocol}//${window.location.host}`,hostURL:["http://127.0.0.1:11180"],localURL:"http://localhost:11180",code:e.get("code")||"",isCustom:e.get("cus")||0,templatePath:t||"",presetId:e.get("preset")||0});let n=[];const a=e=>{if("fastRender"===e.key){const e=JSON.parse(localStorage.getItem("fastRender"));1==!!e?.templateId&&(e?.templateId??null)==t&&(e?.presetId??0)==o.presetId&&s(e.cssData)}};function s(e){n=[],e.forEach((e=>{const t=!!e?.flag?.isCss,o=!!e?.flag?.isJs;if(!0===t){const t=e.cssvar,o=e.value||"";document.documentElement.style.setProperty(t,o)}!0===o&&n.push({code:e.code,data:e.data})})),n.length>0&&window.dispatchEvent(new CustomEvent("presetDataUpdated",{detail:n}))}const c=ref([]);let r=new Map,d=0;const m=e=>{Vue.nextTick((()=>{const t=document.querySelector(`[data-comment-index="${e.commentIndex}"]`);if(!t)return!1;const o=t.querySelector(".scroll-size"),n=t.querySelector(".scroll-text");if(!o||!n)return!1;const a=o.offsetHeight,s=n.offsetHeight;if(a<=0||s<=0)return!1;if(a<s){let t=4,o=Math.max(0,s-a);t=o>0&&o<=50?4:o>50&&o<=100?8:o>100&&o<=150?12:16;const n=document.querySelector(`[data-comment-index="${e.commentIndex}"] .danmaku`);n&&(n.style.setProperty("--content-height",`${a}px`),n.style.setProperty("--slide-time",`${t}s`));const c=document.querySelector(`[data-comment-index="${e.commentIndex}"] .scroll-size`);c&&c.classList.add("scroll-mode");const r=document.querySelector(`[data-comment-index="${e.commentIndex}"] .scroll-text`);r&&r.classList.add("scroll-animation")}return!0}))};return onMounted((async()=>{await(async()=>{try{const e=await fetch(`${o.baseURL}/api/plugins/${uid}?code=${o.code}&isCustom=${o.isCustom}&presetId=${o.presetId}&templateId=${o.templatePath}`,{method:"GET"}),{response:t}=await e.json();t&&t.data.preset&&s(t.data.preset),document.body.removeAttribute("hidden")}catch(e){}})(),window.addEventListener("storage",a),OneSDK.setup({commentLimit:30}),OneSDK.subscribe({action:"comments",callback:e=>{const t=new Map;e.forEach((e=>{const o=r.get(e.data.id);isNaN(o)?(e.commentIndex=d,t.set(e.data.id,d),d++):(e.commentIndex=o,t.set(e.data.id,o))})),r=t,c.value=e}}),OneSDK.connect()})),onUnmounted((()=>{window.removeEventListener("storage",a)})),watch(c,(()=>{Vue.nextTick((()=>{c.value.forEach((e=>{m(e)}))}))})),{comments:c,getClassName:e=>e.commentIndex%2==0?"comment even":"comment odd",getStyle:e=>OneSDK.getCommentStyle(e),getRole:e=>e.data.isOwner?"role-owner":e.data.isModerator?"role-moderator":e.data.isMember?"role-member":"role-normal",getCommentScroll:m,getPaidtext:e=>e.data.colors?"box box-paidtext":"box"}}});OneSDK.ready().then((()=>{app.mount("#container")}));