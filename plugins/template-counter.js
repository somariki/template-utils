const{createApp,ref,reactive,watch,onMounted,onUnmounted}=Vue,uid="onecomme.plugin.template-utils",LIMIT=30,app=createApp({setup(){const t=new URLSearchParams(window.location.search),e=`${window.location.pathname}`.substring(1).split("/").slice(1,3).join("/")||null,a=reactive({baseURL:`${window.location.protocol}//${window.location.host}`,hostURL:["http://127.0.0.1:11180"],localURL:"http://localhost:11180",socketPort:11190,code:t.get("code")||"",isCustom:t.get("cus")||0,templatePath:e||"",presetId:t.get("preset")||0}),r=ref(null),o=reactive({target:0,cacheTarget:0,current:0,counterStatus:!1}),n=reactive({target:0,cacheTarget:0,current:0,counterStatus:!1}),c=reactive({target:0,cacheTarget:0,current:0,counterStatus:!1}),u=reactive({intValue:0,floatValue:0}),s=reactive({intValue:0,floatValue:0}),d=reactive({intValue:0,floatValue:0});let l=[];const i=t=>{if("fastRender"===t.key){const t=JSON.parse(localStorage.getItem("fastRender"));1==!!t?.templateId&&(t?.templateId??null)==e&&(t?.presetId??0)==a.presetId&&p(t.cssData)}};function p(t){l=[],t.forEach((t=>{const e=!!t?.flag?.isCss,a=!!t?.flag?.isJs;if(!0===e){const e=t.cssvar,a=t.value||"";document.documentElement.style.setProperty(e,a)}if(!0===a){l.push({code:t.code,data:t.data});switch((t.data||{}).counterIndex){case 1:o.counterStatus=!0;break;case 2:n.counterStatus=!0;break;case 3:c.counterStatus=!0}}})),l.length>0&&window.dispatchEvent(new CustomEvent("presetDataUpdated",{detail:l}))}watch((()=>[o.current,o.target]),(([t,e])=>{let a=0;e>0&&(a=t/e*100),a=Math.max(0,Math.min(a,100)),u.intValue=Math.floor(a),u.floatValue=Math.round(100*a)/100})),watch((()=>[n.current,n.target]),(([t,e])=>{let a=0;e>0&&(a=t/e*100),a=Math.max(0,Math.min(a,100)),s.intValue=Math.floor(a),s.floatValue=Math.round(100*a)/100})),watch((()=>[c.current,c.target]),(([t,e])=>{let a=0;e>0&&(a=t/e*100),a=Math.max(0,Math.min(a,100)),d.intValue=Math.floor(a),d.floatValue=Math.round(100*a)/100}));const g=async()=>{try{const t=await fetch(`${a.baseURL}/api/plugins/${uid}?port=true&code=${a.code}&isCustom=${a.isCustom}&presetId=${a.presetId}&templateId=${a.templatePath}`,{method:"GET"}),{response:e}=await t.json();e&&e.data.port&&e.data.port!==a.socketPort&&(a.socketPort=e.data.port),e&&e.data.preset&&p(e.data.preset),(()=>{let t="counter";!0===o.counterStatus&&(t+=",counter1"),!0===n.counterStatus&&(t+=",counter2"),!0===c.counterStatus&&(t+=",counter3");const e=window.location.hostname+`:${a.socketPort}`,u=`${window.location.protocol}//${e}/utils?p=${t}`;r.value=new WebSocket(u),r.value.onopen=()=>{},r.value.onmessage=t=>{const e=JSON.parse(t.data);"ping"===e?.type?(void 0!==e?.data?.counter1&&(0==o.current&&(o.current=e?.data?.counter1||0),0==o.target&&(o.target=e?.data?.target1||0)),void 0!==e?.data?.counter2&&(0==n.current&&(n.current=e?.data?.counter2||0),0==n.target&&(n.target=e?.data?.target2||0)),void 0!==e?.data?.counter3&&(0==c.current&&(c.current=e?.data?.counter3||0),0==c.target&&(c.target=e?.data?.target3||0))):"update"===e?.type&&(void 0!==e?.data?.counter1&&(o.current=e?.data?.counter1||0,o.target=e?.data?.target1||0),void 0!==e?.data?.counter2&&(n.current=e?.data?.counter2||0,n.target=e?.data?.target2||0),void 0!==e?.data?.counter3&&(c.current=e?.data?.counter3||0,c.target=e?.data?.target3||0))},r.value.onerror=t=>{},r.value.onclose=()=>{}})(),document.body.removeAttribute("hidden")}catch(t){}};return onMounted((async()=>{await g(),window.addEventListener("storage",i)})),onUnmounted((()=>{window.removeEventListener("storage",i),r.value&&r.value.close()})),{counter1:o,percentage1:u,counter2:n,percentage2:s,counter3:c,percentage3:d}}});OneSDK.ready().then((()=>{app.mount("#container")}));