const Ie=(e,t)=>{if(ne(e)&&ne(t))for(const l in t)ne(t[l])?(e[l]||Object.assign(e,{[l]:{}}),Ie(e[l],t[l])):Object.assign(e,{[l]:t[l]});return e},ne=e=>e&&"object"==typeof e&&!Array.isArray(e),We=window.Vue.defineComponent,Be=window.Vue.renderList,Ee=window.Vue.Fragment,m=window.Vue.openBlock,N=window.Vue.createElementBlock,le=window.Vue.withModifiers,_e=window.Vue.normalizeStyle,V=window.Vue.createElementVNode,C=window.Vue.renderSlot,b=window.Vue.toDisplayString,D=window.Vue.createCommentVNode,se=window.Vue.createTextVNode,re=window.Vue.normalizeClass,Ge=window.Vue.resolveComponent,F=window.Vue.withCtx,Qe=window.Vue.createBlock,Ze=window.Vue.vShow,et=window.Vue.withDirectives,tt={ref:"nodes",class:"sl-vue-tree-next-nodes-list"},ot=["onMousedown","onMouseup","onContextmenu","onDblclick","onClick","onDragover","onDrop","path"],nt={class:"sl-vue-tree-next-gap"},lt={key:0,class:"sl-vue-tree-next-branch"},st={key:0},rt={key:1},it={class:"sl-vue-tree-next-title"},at=["onClick"],ut={class:"sl-vue-tree-next-sidebar"},S=window.Vue.ref,ct=window.Vue.onMounted,dt=window.Vue.onBeforeUnmount,ft=window.Vue.watchEffect,_=window.Vue.computed,pt=We({__name:"SlVueTreeNext",props:{modelValue:{default:()=>[]},edgeSize:{default:3},allowMultiselect:{type:Boolean,default:!0},showBranches:{type:Boolean,default:!1},level:{default:0},parentInd:{default:void 0},parentContext:{},rootContext:{},allowToggleBranch:{type:Boolean,default:!0},multiSelectKey:{},scrollAreaHeight:{default:70},maxScrollSpeed:{default:20}},emits:["update:modelValue","select","beforedrop","drop","toggle","nodeclick","nodedblclick","updateNode","nodecontextmenu","externaldragover","externaldrop"],setup(e,{expose:t,emit:l}){const n=e,o=l,r=S(),i=S(),a=S(null),s=S(0),u=S(0),d=S(null),c=S(!1),v=S(!1),p=S({x:0,y:0}),h=S(!1),f=S([]),g=_((()=>!n.level)),w=_((()=>{const e=[];let t=n.level-1;for(n.showBranches||t++;t-- >0;)e.push(t);return e})),x=_((()=>{var e;return g.value?a.value:null==(e=W())?void 0:e.cursorPosition.value})),y=_((()=>w.value.length)),B=_((()=>{var e,t,l,o;if(g.value){const e=de(f.value);return M(e)}return null===n.parentInd?[]:null==(o=null==(l=null==(t=null==(e=W())?void 0:e.currentNodes)?void 0:t.value)?void 0:l[n.parentInd])?void 0:o.children})),k=_((()=>te().length));_((()=>ne().length)),ct((()=>{g.value&&document.addEventListener("mouseup",j)})),dt((()=>{document.removeEventListener("mouseup",j)})),ft((()=>{f.value=n.modelValue}));const E=e=>{var t;g.value?a.value=e:null==(t=W())||t.setCursorPosition(e)},M=(e,t=[],l=!0)=>e.map(((n,o)=>{const r=t.concat(o);return L(r,n,e,l)})),L=(e,t=null,l=null,n=null)=>{const o=e.slice(-1)[0];if(l=l||q(f.value,e),t=t||l&&l[o]||null,null==n&&(n=null==A?void 0:A(e)),!t)return null;const r=null==t.isExpanded||!!t.isExpanded,i=null==t.isDraggable||!!t.isDraggable,a=null==t.isSelectable||!!t.isSelectable;return{title:t.title,isLeaf:!!t.isLeaf,children:t.children?M(t.children,e,r):[],isSelected:!!t.isSelected,isExpanded:r,isVisible:n,isDraggable:i,isSelectable:a,data:void 0!==t.data?t.data:{},path:e,pathStr:JSON.stringify(e),level:e.length,ind:o,isFirstChild:0==o,isLastChild:o==((null==l?void 0:l.length)??0)-1}},A=e=>{if(e.length<2)return!0;let t=f.value;for(let l=0;l<e.length-1;l++){let n=t[e[l]];if(null!=n.isExpanded&&!n.isExpanded)return!1;t=n.children||[]}return!0},P=e=>{f.value=e,Z().emit("update:modelValue",e)},O=(e,t=!1,l=null)=>{const o=Array.isArray(n.multiselectKey)?n.multiselectKey:[n.multiselectKey];t=(l&&!!o.find((e=>l[e]))||t)&&n.allowMultiselect;const r=L(e);if(!r)return null;const i=de(f.value),a=n.allowMultiselect&&l&&l.shiftKey&&d.value,s=[];let u=!1;return oe(((e,l)=>{var n;a?((e.pathStr===r.pathStr||e.pathStr===(null==(n=d.value)?void 0:n.pathStr))&&(l.isSelected=e.isSelectable,u=!u),u&&(l.isSelected=e.isSelectable)):e.pathStr===r.pathStr?l.isSelected=e.isSelectable:t||l.isSelected&&(l.isSelected=!1),l.isSelected&&s.push(e)}),i),d.value=r,P(i),((e,t)=>{Z().emit("select",e,t)})(s,l),r},$=e=>{var t,l;if(!g.value)return void(null==(t=Z())||t.onMousemoveHandler(e));if(h.value)return;const o=v.value,i=o||c.value&&(p.value.x!==e.clientX||p.value.y!==e.clientY),a=!1===o&&!0===i;if(p.value={x:e.clientX,y:e.clientY},!i)return;const s=Z().ref.value,u=s.getBoundingClientRect(),d=e.clientY-u.top+s.scrollTop-Number((null==(l=r.value)?void 0:l.style.marginBottom)??0),f=e.clientX-u.left;r.value&&(r.value.style.top=d+"px",r.value.style.left=f+"px");const m=H(e.clientX,e.clientY),S=null==m?void 0:m.node,w=null==m?void 0:m.placement;if(a&&!S.isSelected&&O(S.path,!1,e),!ne().length)return void(h.value=!0);v.value=i,E({node:S,placement:w});const x=u.bottom-n.scrollAreaHeight,b=(e.clientY-x)/(u.bottom-x),y=u.top+n.scrollAreaHeight,C=(y-e.clientY)/(y-u.top);b>0?X(b):C>0?X(-C):K()},H=(e,t)=>{const l=document.elementFromPoint(e,t),o=null!=l&&l.getAttribute("path")?l:I(l);let r,i;if(o){if(!o)return;r=L(JSON.parse(o.getAttribute("path")));const e=o.offsetHeight,l=n.edgeSize,a=t-o.getBoundingClientRect().top;i=r.isLeaf?a>=e/2?"after":"before":a<=l?"before":a>=e-l?"after":"inside"}else{const e=Z().ref.value.getBoundingClientRect();t>e.top+e.height/2?(i="after",r=J()):(i="before",r=T())}return{node:r,placement:i}},I=e=>e?e.getAttribute("path")?e:I(e.parentElement):null,Y=e=>{if(!g.value||!v.value)return;const t=Z().ref.value.getBoundingClientRect();if(e.clientY>=t.bottom){const e=structuredClone(B.value);E({node:e[0],placement:"after"})}else e.clientY<t.top&&E({node:T(),placement:"before"})},J=()=>{let e=null;return oe((t=>{e=t})),e},T=()=>L([0]),z=(e,t)=>{for(let l=0;l<e.length;l++){if(null==t[l]||e[l]>t[l])return 1;if(e[l]<t[l])return-1}return null==t[e.length]?0:-1},R=(e,t)=>{if(0===e.button){if(!g.value)return void Z().onNodeMousedownHandler(e,t);c.value=!0}},X=e=>{const t=Z().ref.value;u.value!==e&&(s.value&&K(),u.value=e,s.value=setInterval((()=>{t.scrollTop+=n.maxScrollSpeed*e}),20))},K=()=>{clearInterval(s.value),s.value=0,u.value=0},j=e=>{v.value&&G(e)},G=(e,t=null)=>{if(0!==e.button)return;if(!g.value)return void Z().onNodeMouseupHandler(e,t);if(c.value=!1,!v.value&&t&&!h.value&&O(t.path,!1,e),h.value=!1,!x.value)return void U();const l=ne();for(let e of l){if(e.pathStr==x.value.node.pathStr)return void U();if(ue(e,x.value.node))return void U()}const n=de(f.value),o=[];for(let e of l){const t=q(n,e.path)[e.ind];o.push(t)}let r=!1;if(((e,t,l)=>{Z().emit("beforedrop",e,t,l)})(l,x.value,(()=>r=!0)),r)return void U();const i=[];for(let e of o)i.push(de(e)),e.toBeDeleted=!0;ae(x.value,i,n),ie(((e,t,l)=>{e.toBeDeleted&&t.splice(l,1)}),n),d.value=null,P(n),((e,t,l)=>{Z().emit("drop",e,t,l)})(l,x.value,e),U()},Q=(e,t)=>{n.allowToggleBranch&&(ee({path:t.path,patch:{isExpanded:!t.isExpanded}}),((e,t)=>{Z().emit("toggle",e,t)})(t,e),e.stopPropagation())},U=()=>{v.value=!1,c.value=!1,E(null),K()},W=()=>n.parentContext,Z=()=>g.value?ce:n.rootContext,q=(e,t)=>1===t.length?e:q(e[t[0]].children,t.slice(1)),ee=({path:e,patch:t})=>{if(!g.value)return void o("updateNode",{path:e,patch:t});const l=JSON.stringify(e),n=de(f.value);oe(((e,n)=>{if(e.pathStr===l)return Ie(n,t),!1}),n),P(n)},te=()=>{const e=[];return oe((t=>{t.isSelected&&e.push(t)})),e},ne=()=>{const e=[];return oe((t=>{t.isSelected&&t.isDraggable&&(e.some((e=>((e,t)=>JSON.stringify(e.path.slice(0,t.path.length))===t.pathStr)(t,e)))||e.push(t))})),e},oe=(e,t=null,l=[])=>{t||(t=f.value);let n=!1;const o=[];for(let r=0;r<t.length;r++){const i=t[r],a=l.concat(r),s=L(a,i,t);if(n=!1===e(s,i,t),s&&o.push(s),n||i.children&&(n=!1===oe(e,i.children,a),n))break}return!n&&o},ie=(e,t)=>{let l=t.length;for(;l--;){const n=t[l];n.children&&ie(e,n.children),e(n,t,l)}return t},ae=(e,t,l)=>{const n=de(e),o=n.node,r=q(l,o.path),i=r[o.ind];if("inside"===n.placement)i.children=i.children||[],i.children.unshift(...t);else{const e="before"===n.placement?o.ind:o.ind+1;r.splice(e,0,...t)}},ue=(e,t)=>{const l=de(t).path;return JSON.stringify(l.slice(0,e.path.length))==e.pathStr},de=e=>JSON.parse(JSON.stringify(e)),ce={getRoot:Z,setCursorPosition:E,currentNodes:B,cursorPosition:x,emit:o,ref:i,onNodeMousedownHandler:R,onNodeMouseupHandler:G,onMousemoveHandler:$,getCursorPositionFromCoords:H,updateNode:ee,getNode:L,traverse:oe,select:O,getNodeEl:e=>Z().ref.value.querySelector(`[path="${JSON.stringify(e)}"]`),getFirstNode:T,getLastNode:J,getNextNode:(e,t)=>{let l=null;return oe((n=>{if(!(z(n.path,e)<1)&&(!t||t(n)))return l=n,!1})),l},getPrevNode:(e,t)=>{let l=[];oe((t=>{if(z(t.path,e)>=0)return!1;l.push(t)}));let n=l.length;for(;n--;){const e=l[n];if(!t||t(e))return e}return null},getSelected:te,insert:(e,t)=>{const l=Array.isArray(t)?t:[t],n=de(f.value);ae(e,l,n),P(n)},remove:e=>{const t=e.map((e=>JSON.stringify(e))),l=de(f.value);oe(((e,l,n)=>{for(const n of t)e.pathStr===n&&(l.toBeDeleted=!0)}),l),ie(((e,t,l)=>{e.toBeDeleted&&t.splice(l,1)}),l),P(l)},rootCursorPosition:a,selectionSize:k};return t(ce),(e,t)=>{const l=Ge("SlVueTreeNext",!0);return m(),N("div",{ref_key:"rootRef",ref:i,class:re(["sl-vue-tree-next",{"sl-vue-tree-next-root":g.value}]),onMousemove:$,onMouseleave:Y},[V("div",tt,[(m(!0),N(Ee,null,Be(B.value,((n,o)=>(m(),N("div",{class:re(["sl-vue-tree-next-node",{"sl-vue-tree-next-selected":n.isSelected}])},[V("div",{class:"sl-vue-tree-next-cursor sl-vue-tree-next-cursor_before",onDragover:t[0]||(t[0]=le((()=>{}),["prevent"])),style:_e({visibility:x.value&&x.value.node.pathStr===n.pathStr&&"before"===x.value.placement?"visible":"hidden","--depth":y.value})},null,36),V("div",{class:re(["sl-vue-tree-next-node-item",{"sl-vue-tree-next-cursor-hover":x.value&&x.value.node.pathStr===n.pathStr,"sl-vue-tree-next-cursor-inside":x.value&&"inside"===x.value.placement&&x.value.node.pathStr===n.pathStr,"sl-vue-tree-next-node-is-leaf":n.isLeaf,"sl-vue-tree-next-node-is-folder":!n.isLeaf}]),onMousedown:e=>R(e,n),onMouseup:e=>G(e,n),onContextmenu:e=>((e,t)=>{Z().emit("nodecontextmenu",e,t)})(n,e),onDblclick:e=>((e,t)=>{Z().emit("nodedblclick",e,t)})(n,e),onClick:e=>((e,t)=>{Z().emit("nodeclick",e,t)})(n,e),onDragover:e=>((e,t)=>{t.preventDefault();const l=Z(),n=l.getCursorPositionFromCoords(t.clientX,t.clientY);l.setCursorPosition(n),l.emit("externaldragover",n,t)})(0,e),onDrop:e=>((e,t)=>{const l=Z(),n=l.getCursorPositionFromCoords(t.clientX,t.clientY);l.emit("externaldrop",n,t),E(null)})(0,e),path:n.pathStr},[(m(!0),N(Ee,null,Be(w.value,(e=>(m(),N("div",nt)))),256)),e.level&&e.showBranches?(m(),N("div",lt,[C(e.$slots,"branch",{node:n},(()=>[n.isLastChild?D("",!0):(m(),N("span",st,b("├")+b("─")+"  ",1)),n.isLastChild?(m(),N("span",rt,b("└")+b("─")+"  ",1)):D("",!0)]))])):D("",!0),V("div",it,[n.isLeaf?D("",!0):(m(),N("span",{key:0,class:"sl-vue-tree-next-toggle",onClick:e=>Q(e,n)},[C(e.$slots,"toggle",{node:n},(()=>[V("span",null,b(n.isLeaf?"":n.isExpanded?"-":"+"),1)]))],8,at)),C(e.$slots,"title",{node:n},(()=>[se(b(n.title),1)])),!n.isLeaf&&0==n.children.length&&n.isExpanded?C(e.$slots,"empty-node",{key:1,node:n}):D("",!0)]),V("div",ut,[C(e.$slots,"sidebar",{node:n})])],42,ot),n.children&&n.children.length&&n.isExpanded?(m(),Qe(l,{key:0,"model-value":n.children,level:n.level,"parent-ind":o,"allow-multiselect":e.allowMultiselect,"allow-toggle-branch":e.allowToggleBranch,"edge-size":e.edgeSize,"show-branches":e.showBranches,"parent-context":ce,"root-context":g.value?ce:e.rootContext,onUpdateNode:ee,onDragover:t[1]||(t[1]=le((()=>{}),["prevent"]))},{title:F((({node:t})=>[C(e.$slots,"title",{node:t},(()=>[se(b(t.title),1)]))])),toggle:F((({node:t})=>[C(e.$slots,"toggle",{node:t},(()=>[V("span",null,b(t.isLeaf?"":t.isExpanded?"-":"+"),1)]))])),sidebar:F((({node:t})=>[C(e.$slots,"sidebar",{node:t})])),"empty-node":F((({node:t})=>[!t.isLeaf&&0==t.children.length&&t.isExpanded?C(e.$slots,"empty-node",{key:0,node:t}):D("",!0)])),_:2},1032,["model-value","level","parent-ind","allow-multiselect","allow-toggle-branch","edge-size","show-branches","root-context"])):D("",!0),V("div",{class:"sl-vue-tree-next-cursor sl-vue-tree-next-cursor_after",onDragover:t[2]||(t[2]=le((()=>{}),["prevent"])),style:_e({visibility:x.value&&x.value.node.pathStr===n.pathStr&&"after"===x.value.placement?"visible":"hidden","--depth":y.value})},null,36)],2)))),256)),g.value?et((m(),N("div",{key:0,ref_key:"dragInfoRef",ref:r,class:"sl-vue-tree-next-drag-info"},[C(e.$slots,"draginfo",{},(()=>[se(" Items: "+b(k.value),1)]))],512)),[[Ze,v.value]]):D("",!0)],512)],34)}}});export{pt as SlVueTreeNext};