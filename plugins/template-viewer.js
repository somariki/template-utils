const{createApp,ref,reactive,watch,onMounted,onUnmounted}=Vue,uid="onecomme.plugin.template-utils",app=createApp({setup(){const e=new URLSearchParams(window.location.search),t=`${window.location.pathname}`.substring(1).split("/").slice(1,3).join("/")||null,a=reactive({baseURL:`${window.location.protocol}//${window.location.host}`,hostURL:["http://127.0.0.1:11180"],localURL:"http://localhost:11180",code:e.get("code")||"",isCustom:e.get("cus")||0,templatePath:t||"",presetId:e.get("preset")||0}),o=ref(null),s=`${a.baseURL}/api/plugins/${uid}?code=${a.code}&isCustom=${a.isCustom}&presetId=${a.presetId}&templateId=${a.templatePath}`,n=reactive({id:null,cacheId:null,socketURL:`${a.baseURL}/sub?p=service,meta`,apiURL:`${a.baseURL}/api/services`}),i={viewer:0,follower:0,upVote:0,subscriberCount:0,total:0,startTime:0},c=reactive({...i});let r=[];const l=e=>{if("fastRender"===e.key){const e=JSON.parse(localStorage.getItem("fastRender"));1==!!e?.templateId&&(e?.templateId??null)==t&&(e?.presetId??0)==a.presetId&&d(e.cssData)}};function d(e){if(r=[],e.forEach((e=>{const t=!!e?.flag?.isCss,a=!!e?.flag?.isJs;if(!0===t){const t=e.cssvar,a=e.value||"";document.documentElement.style.setProperty(t,a)}!0===a&&r.push({code:e.code,data:e.data})})),Object.keys(r).length>0){const e=r.find((e=>"onecomme-service"===e.code))?.data||null;null!==e?.value&&"service-id"!==e?.value&&(n.id=e?.value||null),null!=n.id&&n.cacheId!==n.id&&(Object.assign(c,i),p(),m(),n.cacheId=n.id)}r.length>0&&window.dispatchEvent(new CustomEvent("presetDataUpdated",{detail:r}))}function u(e){e.viewer&&(c.viewer=e.viewer),e.follower&&(c.follower=e.follower),e.subscriberCount&&(c.subscriberCount=e.subscriberCount),e.upVote&&(c.upVote=e.upVote),e.total&&(c.total=e.total),e.startTime&&(c.startTime=e.startTime)}const p=async()=>{try{const e=await fetch(n.apiURL);if(!e.ok)throw new Error("Network response was not ok");(await e.json()).forEach((e=>{n.id==e.id&&u(e.meta)}))}catch(e){}},m=()=>{o.value=new WebSocket(n.socketURL),o.value.onopen=()=>{},o.value.onmessage=e=>{const t=JSON.parse(e.data);if("meta"==t.type&&t.data.service.id){if(t.data.service.id==n.id){u(t.data.data?t.data.data:{})}}},o.value.onerror=e=>{},o.value.onclose=()=>{}};return onMounted((()=>{(async()=>{try{const e=await fetch(s,{method:"GET"}),{response:t}=await e.json();t&&t.data.preset&&d(t.data.preset),null!=n.id&&(await p(),m()),document.body.removeAttribute("hidden")}catch(e){}})(),window.addEventListener("storage",l)})),onUnmounted((()=>{window.removeEventListener("storage",l),o.value&&o.value.close()})),{visitorData:c}}});app.mount("#app");